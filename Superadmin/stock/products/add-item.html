<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إضافة مخزون - نظام إدارة المخازن</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../../assets/css/style.css">
</head>
<body>
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h3>نظام إدارة المخازن</h3>
                <button class="sidebar-close" id="sidebarClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="sidebar-menu">
                <ul>
                    <li><a href="/Superadmin/index.html"><i class="fas fa-home"></i> لوحة التحكم</a></li>
                    <li><a href="/Superadmin/vendor/vendors.html"><i class="fas fa-building"></i> إدارة الشركات</a></li>
                    <li><a href="/Superadmin/warehouse/warehouses.html"><i class="fas fa-warehouse"></i> إدارة المخازن</a></li>
                    <li><a href="/Superadmin/employee/employees.html"><i class="fas fa-users"></i> إدارة الموظفين</a></li>
                    <li><a href="/Superadmin/suppliers/suppliers.html"><i class="fas fa-truck"></i> إدارة الموردين</a></li>
                    <li><a href="/Superadmin/sales/sales.html"><i class="fas fa-truck"></i> إدارة المبيعات</a></li>
                    <li class="active"><a href="/Superadmin/stock/products/stock.html"><i class="fas fa-boxes"></i> إدارة المخزون</a></li>
                    <li><a href="/Superadmin/custody/custody.html"><i class="fas fa-hand-holding"></i> إدارة العهدة</a></li>
                    <li><a href="/Superadmin/reports.html"><i class="fas fa-chart-bar"></i> التقارير</a></li>
                    <li><a href="/Superadmin/transactions.html"><i class="fas fa-history"></i> سجل المعاملات</a></li>
                    <li><a href="/Superadmin/settings.html"><i class="fas fa-cog"></i> الإعدادات</a></li>
                </ul>
            </div>
        </div>

        <div class="main-content">
            <div class="header">
                <div class="header-left">
                    <div class="menu-toggle-container">
                        <button class="menu-toggle" id="menuToggle">
                            <i class="fas fa-bars"></i>
                        </button>
                        <span class="mobile-header-title" id="headerTitle">إضافة مخزون</span>
                    </div>
                    <select class="vendor-dropdown" id="companyDropdown">
                        <option value="all">جميع الشركات</option>
                    </select>
                    <select class="warehouse-dropdown" id="warehouseDropdown">
                        <option value="all">جميع المخازن</option>
                    </select>
                </div>
                <div class="user-info">
                    <img src="https://via.placeholder.com/40" alt="User">
                    <span id="userNameDisplay">سوبر أدمن</span>
                    <div class="dropdown">
                        <i class="fas fa-chevron-down"></i>
                        <div class="dropdown-content">
                            <a href="/Superadmin/settings.html">الإعدادات</a>
                            <a href="/Superadmin/login.html">تسجيل الخروج</a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 id="cardTitle">إضافة مخزون جديد</h3>
                </div>
                <div class="card-body">
                    <form id="stockForm" onsubmit="saveItem(event)">
                        <div class="form-container">
                            <input type="hidden" id="itemId">
                            <div class="form-group">
                                <label for="itemTitle">العنوان</label>
                                <input type="text" class="form-control" id="itemTitle" placeholder="أدخل العنوان" required>
                            </div>
                            <div class="form-group">
                                <label for="itemDescription">الوصف</label>
                                <textarea class="form-control" id="itemDescription" rows="4" placeholder="أدخل الوصف"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="itemImage">الصورة</label>
                                <input type="file" class="form-control" id="itemImage" accept="image/*">
                            </div>
                            <div class="form-group">
                                <label for="category">الفئة</label>
                                <select class="form-control" id="category" required>
                                    <option value="">اختر الفئة</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="purchasePrice">سعر الشراء</label>
                                <input type="number" class="form-control" id="purchasePrice" min="0" step="0.01" placeholder="أدخل سعر الشراء" required>
                            </div>
                            <div class="form-group">
                                <label for="salePrice">سعر البيع</label>
                                <input type="number" class="form-control" id="salePrice" min="0" step="0.01" placeholder="أدخل سعر البيع" required>
                            </div>
                            <div class="form-group">
                                <label for="firstTax">الضريبة الأولى</label>
                                <select class="form-control" id="firstTax">
                                    <option value="">بدون ضريبة</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="secondTax">الضريبة الثانية</label>
                                <select class="form-control" id="secondTax">
                                    <option value="">بدون ضريبة</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="discount">الخصم</label>
                                <input type="number" class="form-control" id="discount" min="0" step="0.01" placeholder="أدخل الخصم">
                            </div>
                            <div class="form-group">
                                <label>نوع الخصم</label>
                                <div>
                                    <label><input type="radio" name="discountType" value="fixed" checked> قيمة ثابتة</label>
                                    <label><input type="radio" name="discountType" value="percentage"> نسبة مئوية</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="threshold">نبهني عند وصول الكمية إلى أقل من</label>
                                <input type="number" class="form-control" id="threshold" min="0" placeholder="أدخل القيمة">
                            </div>
                            <div class="form-group full-width">
                                <button type="submit" class="btn btn-primary">حفظ</button>
                                <a href="/Superadmin/stock/products/stock.html" class="btn btn-danger">إلغاء</a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Load data from localStorage
        let stockItems = JSON.parse(localStorage.getItem('stockItems')) || [];
        let companies = JSON.parse(localStorage.getItem('companies')) || [
            { id: 1, name: "شركة المستقبل" },
            { id: 2, name: "شركة التقدم" }
        ];
        let warehouses = JSON.parse(localStorage.getItem('warehouses')) || [
            { id: 1, name: "المخزن الرئيسي", companyId: 1 },
            { id: 2, name: "مخزن الفرع الشمالي", companyId: 1 }
        ];
        let suppliers = JSON.parse(localStorage.getItem('suppliers')) || [
            { id: 1, name: "مورد التقنية" }
        ];
        let categories = JSON.parse(localStorage.getItem('categories')) || [
            { id: 1, name: "إلكترونيات", description: "الأجهزة الإلكترونية والملحقات" }
        ];
        let taxes = JSON.parse(localStorage.getItem('taxes')) || [
            { id: 1, name: "ضريبة القيمة المضافة", rate: 14, description: "ضريبة القيمة المضافة القياسية" }
        ];
        let currentUser = JSON.parse(localStorage.getItem('currentUser')) || { 
            role: "Super Admin",
            name: "سوبر أدمن",
            email: "superadmin@example.com",
            password: "admin123",
            plan: {
                name: "SuperGrok",
                status: "نشط",
                expiryDate: "2026-07-17"
            }
        };

        // Update dropdowns
        function updateDropdowns() {
            const companyDropdown = document.getElementById('companyDropdown');
            const warehouseDropdown = document.getElementById('warehouseDropdown');
            const categorySelect = document.getElementById('category');
            const firstTaxSelect = document.getElementById('firstTax');
            const secondTaxSelect = document.getElementById('secondTax');

            companyDropdown.innerHTML = '<option value="all">جميع الشركات</option>';
            warehouseDropdown.innerHTML = '<option value="all">جميع المخازن</option>';
            categorySelect.innerHTML = '<option value="">اختر الفئة</option>';
            firstTaxSelect.innerHTML = '<option value="">بدون ضريبة</option>';
            secondTaxSelect.innerHTML = '<option value="">بدون ضريبة</option>';

            companies.forEach(company => {
                const option = document.createElement('option');
                option.value = company.id;
                option.textContent = company.name;
                companyDropdown.appendChild(option);
            });

            warehouses.forEach(warehouse => {
                const option = document.createElement('option');
                option.value = warehouse.id;
                option.textContent = warehouse.name;
                warehouseDropdown.appendChild(option);
            });

            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                categorySelect.appendChild(option);
            });

            taxes.forEach(tax => {
                const option1 = document.createElement('option');
                option1.value = tax.id;
                option1.textContent = `${tax.name} (${tax.rate}%)`;
                firstTaxSelect.appendChild(option1.cloneNode(true));
                secondTaxSelect.appendChild(option1.cloneNode(true));
            });
        }

        // Load user info
        function loadUserInfo() {
            document.getElementById('userNameDisplay').textContent = currentUser.name || "سوبر أدمن";
        }

        // Parse query parameters
        const params = new URLSearchParams(window.location.search);
        const itemId = params.get('id');

        // Handle edit mode
        if (itemId) {
            const item = stockItems.find(i => i.id === parseInt(itemId));
            if (item) {
                document.getElementById('cardTitle').textContent = 'تعديل مخزون';
                document.getElementById('headerTitle').textContent = 'تعديل مخزون';
                document.getElementById('itemId').value = item.id;
                document.getElementById('itemTitle').value = item.name;
                document.getElementById('itemDescription').value = item.description || '';
                document.getElementById('category').value = item.category;
                document.getElementById('purchasePrice').value = item.unitPrice || '';
                document.getElementById('salePrice').value = item.salePrice || '';
                document.getElementById('firstTax').value = item.firstTax || '';
                document.getElementById('secondTax').value = item.secondTax || '';
                document.getElementById('discount').value = item.discount || '';
                document.querySelector(`input[name="discountType"][value="${item.discountType || 'fixed'}"]`).checked = true;
                document.getElementById('threshold').value = item.threshold || '';
            }
        }

        // Handle form submission
        function saveItem(event) {
            event.preventDefault();
            const id = parseInt(document.getElementById('itemId').value) || (stockItems.length ? Math.max(...stockItems.map(i => i.id)) + 1 : 1);
            const itemTitle = document.getElementById('itemTitle').value.trim();
            const itemDescription = document.getElementById('itemDescription').value.trim();
            const itemImage = document.getElementById('itemImage').value || null; // Placeholder for image handling
            const category = parseInt(document.getElementById('category').value);
            const purchasePrice = parseFloat(document.getElementById('purchasePrice').value);
            const salePrice = parseFloat(document.getElementById('salePrice').value);
            const firstTax = parseInt(document.getElementById('firstTax').value) || null;
            const secondTax = parseInt(document.getElementById('secondTax').value) || null;
            const discount = parseFloat(document.getElementById('discount').value) || 0;
            const discountType = document.querySelector('input[name="discountType"]:checked').value;
            const threshold = parseInt(document.getElementById('threshold').value) || null;

            if (!itemTitle || !category || isNaN(purchasePrice) || isNaN(salePrice)) {
                alert('يرجى ملء جميع الحقول المطلوبة');
                return;
            }

            const item = {
                id,
                name: itemTitle,
                description: itemDescription,
                image: itemImage,
                category,
                companyId: 1, // Default or dynamic based on context
                companyName: "شركة المستقبل", // Default or dynamic
                warehouseId: 1, // Default or dynamic
                warehouseName: "المخزن الرئيسي", // Default or dynamic
                supplierId: 1, // Default or dynamic
                supplierName: "مورد التقنية", // Default or dynamic
                unitPrice: purchasePrice,
                salePrice,
                firstTax,
                secondTax,
                discount,
                discountType,
                quantity: 0, // Default quantity
                status: "كافٍ", // Default status
                threshold,
                notes: ""
            };

            if (itemId) {
                const index = stockItems.findIndex(i => i.id === parseInt(itemId));
                stockItems[index] = item;
            } else {
                stockItems.push(item);
            }

            localStorage.setItem('stockItems', JSON.stringify(stockItems));
            alert('تم حفظ الصنف بنجاح');
            window.location.href = '/Superadmin/stock/products/stock.html';
        }

        // Sidebar toggle
        document.getElementById('menuToggle').addEventListener('click', function() {
            document.getElementById('sidebar').classList.add('active');
            document.getElementById('sidebarOverlay').classList.add('active');
            document.body.style.overflow = 'hidden';
        });

        document.getElementById('sidebarClose').addEventListener('click', closeSidebar);
        document.getElementById('sidebarOverlay').addEventListener('click', closeSidebar);

        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('active');
            document.getElementById('sidebarOverlay').classList.remove('active');
            document.body.style.overflow = '';
        }

        // Initial setup
        updateDropdowns();
        loadUserInfo();
        console.log('add-item.html: Initialized with companies:', companies, 'warehouses:', warehouses, 'suppliers:', suppliers, 'categories:', categories, 'taxes:', taxes, 'stockItems:', stockItems);
    </script>
</body>
</html>