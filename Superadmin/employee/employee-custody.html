<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>عهدة الموظف - نظام إدارة المخازن</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/style.css">
</head>
<body>
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h3>نظام إدارة المخازن</h3>
                <button class="sidebar-close" id="sidebarClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="sidebar-menu">
                <ul>
                    <li><a href="/Superadmin/index.html"><i class="fas fa-home"></i> لوحة التحكم</a></li>
                    <li><a href="/Superadmin/vendor/vendors.html"><i class="fas fa-building"></i> إدارة الشركات</a></li>
                    <li><a href="/Superadmin/warehouse/warehouses.html"><i class="fas fa-warehouse"></i> إدارة المخازن</a></li>
                    <li class="active"><a href="/Superadmin/employee/employees.html"><i class="fas fa-users"></i> إدارة الموظفين</a></li>
                    <li><a href="/Superadmin/suppliers/suppliers.html"><i class="fas fa-truck"></i> إدارة المشتريات</a></li>
                    <li><a href="/Superadmin/sales/sales.html"><i class="fas fa-truck"></i> إدارة المبيعات</a></li>
                    <li><a href="/Superadmin/stock/products/stock.html"><i class="fas fa-boxes"></i> إدارة المخزون</a></li>                    
                    <li><a href="/Superadmin/custody/custody.html"><i class="fas fa-hand-holding"></i> إدارة العهدة</a></li>
                    <li><a href="/Superadmin/reports.html"><i class="fas fa-chart-bar"></i> التقارير</a></li>
                    <li><a href="/Superadmin/transactions.html"><i class="fas fa-history"></i> سجل المعاملات</a></li>
                    <li><a href="/Superadmin/settings.html"><i class="fas fa-cog"></i> الإعدادات</a></li>
                </ul>
            </div>
        </div>

        <div class="main-content">
            <div class="header">
                <div class="header-left">
                    <div class="menu-toggle-container">
                        <button class="menu-toggle" id="menuToggle">
                            <i class="fas fa-bars"></i>
                        </button>
                        <span class="mobile-header-title">عهدة الموظف</span>
                    </div>
                    <select class="vendor-dropdown" id="vendorDropdown">
                        <option value="all">جميع الشركات</option>
                    </select>
                    <select class="warehouse-dropdown" id="warehouseDropdown">
                        <option value="all">جميع المخازن</option>
                    </select>
                </div>
                <div class="user-info">
                    <img src="https://via.placeholder.com/40" alt="User">
                    <span>سوبر أدمن</span>
                    <div class="dropdown">
                        <i class="fas fa-chevron-down"></i>
                        <div class="dropdown-content">
                            <a href="/Superadmin/settings.html">الإعدادات</a>
                            <a href="#">تسجيل الخروج</a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>عهدة الموظف</h3>
                    <a href="/Superadmin/employee/employees.html" class="btn btn-primary">رجوع</a>
                </div>
                <div class="card-body">
                    <div class="employee-info" id="employeeInfo"></div>
                    <div class="tabs">
                        <div class="tab active" onclick="showTab('custodyTab', this)">العهدة</div>
                        <div class="tab" onclick="showTab('installmentsTab', this)">الأقساط</div>
                    </div>
                    <div class="tab-content active" id="custodyTab">
                        <div class="table-responsive">
                            <table id="custodyTable">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>كود العهدة</th>
                                        <th>الشركة</th>
                                        <th>تاريخ التسليم</th>
                                        <th>الحالة</th>
                                        <th>ملاحظات</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="tab-content" id="installmentsTab">
                        <div class="table-responsive">
                            <table id="installmentsTable">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>رقم القسط</th>
                                        <th>المبلغ</th>
                                        <th>تاريخ الاستحقاق</th>
                                        <th>تاريخ الدفع</th>
                                        <th>الحالة</th>
                                        <th>ملاحظات</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Load data from localStorage
        let employees = JSON.parse(localStorage.getItem('employees')) || [
            { id: 1, name: "أحمد محمد", code: "EMP-001", nationalId: "29901010101010", hireDate: "2020-01-15", role: "manager", companyId: 1, warehouseIds: [1, 2], position: "مدير مخازن", department: "إدارة", salary: 5000, phone: "0123456789", email: "ahmed@example.com", address: "القاهرة", image: "https://via.placeholder.com/50" }
        ];
        let companies = JSON.parse(localStorage.getItem('companies')) || [
            { id: 1, name: "شركة المستقبل" },
            { id: 2, name: "شركة التقدم" }
        ];
        let warehouses = JSON.parse(localStorage.getItem('warehouses')) || [
            { id: 1, name: "المخزن الرئيسي", companyId: 1 },
            { id: 2, name: "مخزن الفرع الشمالي", companyId: 1 }
        ];
        let custodyRecords = JSON.parse(localStorage.getItem('custodyRecords')) || [
            {
                id: 1, code: 'CST-2001', companyId: 1, employeeId: 1, items: [
                    { id: 1, code: 'ITM-1001', name: 'كمبيوتر محمول', initialCondition: 'excellent', currentCondition: 'assigned', returnCondition: null, returnNotes: '' }
                ], additionalItems: [
                    { id: 1, name: 'تيشيرت إضافي', code: 'ADD-1001', monthlyDeduction: 10, totalInstallments: 12, paidInstallments: 3, remainingInstallments: 9, totalCost: 100 }
                ], assignDate: '2023-05-15', expectedReturnDate: '2023-08-15', actualReturnDate: null, status: 'active', notes: 'تسليم لموظف جديد', returnCondition: null, returnNotes: null
            }
        ];
        let installments = JSON.parse(localStorage.getItem('installments')) || [
            { id: 1, employeeId: 1, installmentNumber: "INST-001", amount: 1000, dueDate: "2023-01-15", paymentDate: "2023-01-14", status: "مدفوع", notes: "قسط شهر يناير" }
        ];

        // Populate dropdowns
        function populateDropdowns() {
            const vendorDropdown = document.getElementById('vendorDropdown');
            const warehouseDropdown = document.getElementById('warehouseDropdown');

            vendorDropdown.innerHTML = '<option value="all">جميع الشركات</option>';
            companies.forEach(company => {
                const option = document.createElement('option');
                option.value = company.id;
                option.textContent = company.name;
                vendorDropdown.appendChild(option);
            });

            warehouseDropdown.innerHTML = '<option value="all">جميع المخازن</option>';
            warehouses.forEach(warehouse => {
                const option = document.createElement('option');
                option.value = warehouse.id;
                option.textContent = warehouse.name;
                warehouseDropdown.appendChild(option);
            });
        }

        // Populate custody and installments data
        function populateCustodyData() {
            const params = new URLSearchParams(window.location.search);
            const employeeId = parseInt(params.get('id'));
            const employee = employees.find(emp => emp.id === employeeId);

            if (!employee) {
                document.getElementById('employeeInfo').innerHTML = '<p>الموظف غير موجود</p>';
                return;
            }

            const employeeInfo = document.getElementById('employeeInfo');
            employeeInfo.innerHTML = `
                <div class="row" style="display: flex; align-items: center;">
                    <div>
                        <img src="${employee.image || 'https://via.placeholder.com/80'}" class="employee-avatar">
                    </div>
                    <div>
                        <h4>${employee.name}</h4>
                        <p>${employee.position || 'غير محدد'} - ${
                            employee.warehouseIds && employee.warehouseIds.length > 0
                                ? employee.warehouseIds.map(id => warehouses.find(w => w.id === id)?.name || '').join(', ')
                                : 'لا يوجد مخازن'
                        }</p>
                    </div>
                </div>
            `;

            const custodyTbody = document.getElementById('custodyTable').querySelector('tbody');
            custodyTbody.innerHTML = '';
            const employeeCustodies = custodyRecords.filter(c => c.employeeId === employeeId);
            if (employeeCustodies.length === 0) {
                custodyTbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">لا توجد عهدة متاحة</td></tr>';
            } else {
                employeeCustodies.forEach(custody => {
                    const company = companies.find(c => c.id === custody.companyId);
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${custody.id}</td>
                        <td><a href="/Superadmin/custody/show.html?id=${custody.id}">${custody.code}</a></td>
                        <td>${company ? company.name : '-'}</td>
                        <td>${formatDate(custody.assignDate)}</td>
                        <td><span class="badge badge-success">${getStatusText(custody)}</span></td>
                        <td>${custody.notes || '-'}</td>
                    `;
                    custodyTbody.appendChild(row);
                });
            }

            const installmentsTbody = document.getElementById('installmentsTable').querySelector('tbody');
            installmentsTbody.innerHTML = '';
            const employeeInstallments = installments.filter(i => i.employeeId === employeeId);
            if (employeeInstallments.length === 0) {
                installmentsTbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">لا توجد أقساط متاحة</td></tr>';
            } else {
                employeeInstallments.forEach(installment => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${installment.id}</td>
                        <td>${installment.installmentNumber}</td>
                        <td>${installment.amount} ج.م</td>
                        <td>${formatDate(installment.dueDate)}</td>
                        <td>${formatDate(installment.paymentDate)}</td>
                        <td><span class="badge badge-success">${installment.status}</span></td>
                        <td>${installment.notes || '-'}</td>
                    `;
                    installmentsTbody.appendChild(row);
                });
            }
        }

        // Format date for display
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('ar-EG');
        }

        // Get status text
        function getStatusText(record) {
            if (record.status === 'returned') return 'مرجعة';
            const today = new Date();
            const returnDate = new Date(record.expectedReturnDate);
            if (today > returnDate) return 'متأخرة';
            return 'نشطة';
        }

        // Show tab
        function showTab(tabId, element) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            element.classList.add('active');
        }

        // Sidebar toggle
        document.getElementById('menuToggle').addEventListener('click', function() {
            document.getElementById('sidebar').classList.add('active');
            document.getElementById('sidebarOverlay').classList.add('active');
            document.body.style.overflow = 'hidden';
        });

        document.getElementById('sidebarClose').addEventListener('click', closeSidebar);
        document.getElementById('sidebarOverlay').addEventListener('click', closeSidebar);

        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('active');
            document.getElementById('sidebarOverlay').classList.remove('active');
            document.body.style.overflow = '';
        }

        // Initial setup
        populateDropdowns();
        populateCustodyData();
        console.log('employee-custody.html: Initialized with companies:', companies, 'employees:', employees, 'warehouses:', warehouses, 'custodyRecords:', custodyRecords);
    </script>
</body>
</html>