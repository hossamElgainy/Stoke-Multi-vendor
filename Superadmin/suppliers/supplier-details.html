<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تفاصيل المورد - نظام إدارة المخازن</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/style.css">
    <style>
        .supplier-details-card {
            background: linear-gradient(135deg, #f5f7fa, #e4e7eb);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .supplier-details-card p {
            margin: 0;
            flex: 1 1 45%;
            font-size: 16px;
            color: #333;
        }
        .supplier-details-card strong {
            color: #2c3e50;
            font-weight: 700;
            margin-left: 10px;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: flex-end;
        }
        .btn {
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
            border: none;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
            border: none;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }
        .btn-success {
            background-color: #28a745;
            color: white;
            border: none;
        }
        .btn-success:hover {
            background-color: #218838;
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            font-size: 16px;
            color: #333;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        .tab:hover {
            background-color: #f4f4f4;
        }
        .tab.active {
            color: #007bff;
            border-bottom: 3px solid #007bff;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 700;
        }
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        .table-responsive {
            overflow-x: auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 10px;
        }
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .table th,
        .table td {
            padding: 12px;
            border: 1px solid #ddd;
            text-align: right;
        }
        .table th {
            background-color: #007bff;
            color: white;
            font-weight: 700;
        }
        .table td {
            background-color: #fff;
        }
        .table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .badge {
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 12px;
        }
        .badge-success {
            background-color: #28a745;
            color: white;
        }
        .badge-warning {
            background-color: #ffc107;
            color: black;
        }
        .badge-info {
            background-color: #17a2b8;
            color: white;
        }
        .badge-danger {
            background-color: #dc3545;
            color: white;
        }
        @media print {
            .sidebar, .header, .action-buttons, .tabs, .btn, .no-print {
                display: none !important;
            }
            .main-content {
                margin: 0;
                padding: 0;
            }
            .table-responsive {
                box-shadow: none;
                padding: 0;
            }
            .table {
                margin: 0;
            }
            .supplier-details-card {
                display: block;
                margin: 0;
                box-shadow: none;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h3>نظام إدارة المخازن</h3>
                <button class="sidebar-close" id="sidebarClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="sidebar-menu">
                <ul>
                    <li><a href="/Superadmin/index.html"><i class="fas fa-home"></i> لوحة التحكم</a></li>
                    <li><a href="/Superadmin/vendor/vendors.html"><i class="fas fa-building"></i> إدارة الشركات</a></li>
                    <li><a href="/Superadmin/warehouse/warehouses.html"><i class="fas fa-warehouse"></i> إدارة المخازن</a></li>
                    <li><a href="/Superadmin/employee/employees.html"><i class="fas fa-users"></i> إدارة الموظفين</a></li>
                    <li class="active"><a href="/Superadmin/suppliers/suppliers.html"><i class="fas fa-truck"></i> إدارة المشتريات</a></li>
                    <li><a href="/Superadmin/sales/sales.html"><i class="fas fa-truck"></i> إدارة المبيعات</a></li>
                    <li><a href="/Superadmin/stock/products/stock.html"><i class="fas fa-boxes"></i> إدارة المخزون</a></li>
                    <li><a href="/Superadmin/custody/custody.html"><i class="fas fa-hand-holding"></i> إدارة العهدة</a></li>
                    <li><a href="/Superadmin/reports.html"><i class="fas fa-chart-bar"></i> التقارير</a></li>
                    <li><a href="/Superadmin/transactions.html"><i class="fas fa-history"></i> سجل المعاملات</a></li>
                    <li><a href="/Superadmin/settings.html"><i class="fas fa-cog"></i> الإعدادات</a></li>
                </ul>
            </div>
        </div>

        <div class="main-content">
            <div class="header">
                <div class="header-left">
                    <div class="menu-toggle-container">
                        <button class="menu-toggle" id="menuToggle">
                            <i class="fas fa-bars"></i>
                        </button>
                        <span class="mobile-header-title">تفاصيل المورد</span>
                    </div>
                </div>
                <div class="user-info">
                    <img src="https://via.placeholder.com/40" alt="User">
                    <span id="userNameDisplay">سوبر أدمن</span>
                    <div class="dropdown">
                        <i class="fas fa-chevron-down"></i>
                        <div class="dropdown-content">
                            <a href="/Superadmin/settings.html">الإعدادات</a>
                            <a href="/Superadmin/login.html">تسجيل الخروج</a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>تفاصيل المورد</h3>
                </div>
                <div class="card-body">
                    <div class="supplier-details-card">
                        <p><strong>الاسم:</strong> <span id="supplierName"></span></p>
                        <p><strong>جهة الاتصال:</strong> <span id="supplierContactPerson"></span></p>
                        <p><strong>رقم الهاتف:</strong> <span id="supplierPhone"></span></p>
                        <p><strong>البريد الإلكتروني:</strong> <span id="supplierEmail"></span></p>
                        <p><strong>العنوان:</strong> <span id="supplierAddress"></span></p>
                        <p><strong>الشركة:</strong> <span id="supplierVendorName"></span></p>
                        <p><strong>المخازن:</strong> <span id="supplierWarehouseNames"></span></p>
                    </div>
                    <div class="action-buttons">
                        <a href="/Superadmin/suppliers/invoice/add-invoice.html" class="btn btn-primary"><i class="fas fa-file-invoice"></i> إنشاء فاتورة</a>
                        <a id="addSupplierPaymentBtn" href="#" class="btn btn-success"><i class="fas fa-money-bill-wave"></i> إضافة دفعة</a>
                        <button class="btn btn-danger" onclick="showDeleteSupplierConfirm()"><i class="fas fa-trash"></i> حذف المورد</button>
                    </div>
                    <div class="tabs">
                        <div class="tab active" data-tab="details">تفاصيل</div>
                        <div class="tab" data-tab="edit">تعديل</div>
                        <div class="tab" data-tab="invoices">فواتير الشراء</div>
                        <div class="tab" data-tab="returns">مرتجعات المشتريات</div>
                        <div class="tab" data-tab="statement">كشف الحساب</div>
                    </div>
                    <div class="tab-content active" id="details">
                        <h4>المعلومات الرئيسية</h4>
                        <p>الاسم: <span id="detailName"></span></p>
                        <p>جهة الاتصال: <span id="detailContactPerson"></span></p>
                        <p>رقم الهاتف: <span id="detailPhone"></span></p>
                        <p>البريد الإلكتروني: <span id="detailEmail"></span></p>
                        <p>العنوان: <span id="detailAddress"></span></p>
                        <p>الشركة: <span id="detailVendorName"></span></p>
                        <p>المخازن: <span id="detailWarehouseNames"></span></p>
                    </div>
                    <div class="tab-content" id="edit">
                        <h4>تعديل بيانات المورد</h4>
                        <div class="form-group">
                            <label>الاسم</label>
                            <input type="text" id="editName">
                        </div>
                        <div class="form-group">
                            <label>جهة الاتصال</label>
                            <input type="text" id="editContactPerson">
                        </div>
                        <div class="form-group">
                            <label>رقم الهاتف</label>
                            <input type="text" id="editPhone">
                        </div>
                        <div class="form-group">
                            <label>البريد الإلكتروني</label>
                            <input type="email" id="editEmail">
                        </div>
                        <div class="form-group">
                            <label>العنوان</label>
                            <input type="text" id="editAddress">
                        </div>
                        <div class="form-group">
                            <label>الشركة</label>
                            <select id="editVendorId"></select>
                        </div>
                        <div class="form-group">
                            <label>المخازن</label>
                            <select id="editWarehouseIds" multiple></select>
                        </div>
                        <button class="btn btn-primary" onclick="saveSupplierChanges()">حفظ التغييرات</button>
                    </div>
                    <div class="tab-content" id="invoices">
                        <h4>فواتير الشراء</h4>
                        <button class="btn btn-success no-print" onclick="printInvoices()"><i class="fas fa-print"></i> طباعة فواتير الشراء</button>
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>رقم الفاتورة</th>
                                        <th>التاريخ</th>
                                        <th>الشركة</th>
                                        <th>المخزن</th>
                                        <th>الإجمالي</th>
                                        <th>الحالة</th>
                                    </tr>
                                </thead>
                                <tbody id="supplierInvoicesTable"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="tab-content" id="returns">
                        <h4>مرتجعات المشتريات</h4>
                        <button class="btn btn-success no-print" onclick="printReturns()"><i class="fas fa-print"></i> طباعة مرتجعات المشتريات</button>
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>رقم المرتجع</th>
                                        <th>التاريخ</th>
                                        <th>الإجمالي</th>
                                        <th>الحالة</th>
                                    </tr>
                                </thead>
                                <tbody id="supplierReturnsTable"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="tab-content" id="statement">
                        <h4>كشف الحساب</h4>
                        <button class="btn btn-success no-print" onclick="printStatement()"><i class="fas fa-print"></i> طباعة كشف الحساب</button>
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>التاريخ</th>
                                        <th>النوع</th>
                                        <th>الوصف</th>
                                        <th>المبلغ</th>
                                        <th>الرصيد</th>
                                    </tr>
                                </thead>
                                <tbody id="supplierStatementTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Load data from localStorage
        let suppliers = JSON.parse(localStorage.getItem('suppliers')) || [
            {
                id: 1,
                name: "مورد التقنية",
                contactPerson: "علي حسن",
                phone: "01123456789",
                email: "ali@techsupplier.com",
                address: "القاهرة، مصر",
                vendorId: 1,
                vendorName: "شركة المستقبل",
                warehouseIds: [1],
                warehouseNames: ["المخزن الرئيسي"]
            }
        ];
        let vendors = JSON.parse(localStorage.getItem('vendors')) || [
            { id: 1, name: "شركة المستقبل" },
            { id: 2, name: "شركة التقدم" }
        ];
        let warehouses = JSON.parse(localStorage.getItem('warehouses')) || [
            { id: 1, name: "المخزن الرئيسي", vendorId: 1, vendorName: "شركة المستقبل", location: "القاهرة" },
            { id: 2, name: "مخزن الفرع الشمالي", vendorId: 2, vendorName: "شركة التقدم", location: "الإسكندرية" }
        ];
        let invoices = JSON.parse(localStorage.getItem('invoices')) || [
            {
                id: 1,
                invoiceNumber: "INV-001",
                date: "2025-07-15",
                vendorId: 1,
                vendorName: "شركة المستقبل",
                warehouseId: 1,
                warehouseName: "المخزن الرئيسي",
                supplierId: 1,
                supplierName: "مورد التقنية",
                type: "purchase",
                items: [
                    { name: "لابتوب ديل", quantity: 1, unitPrice: 5000, total: 5000 },
                    { name: "ماوس لاسلكي", quantity: 2, unitPrice: 150, total: 300 }
                ],
                total: 5300,
                status: "مدفوع",
                dueDate: "2025-08-15",
                notes: "فاتورة شراء معدات مكتبية"
            }
        ];
        let returns = JSON.parse(localStorage.getItem('returns')) || [];
        let payments = JSON.parse(localStorage.getItem('payments')) || [];
        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        let currentUser = JSON.parse(localStorage.getItem('currentUser')) || { 
            role: "Super Admin",
            name: "سوبر أدمن",
            email: "superadmin@example.com",
            password: "admin123",
            plan: {
                name: "SuperGrok",
                status: "نشط",
                expiryDate: "2026-07-17"
            }
        };

        // Get supplier ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const supplierId = parseInt(urlParams.get('id'));

        // Load supplier details
        function loadSupplierDetails() {
            if (isNaN(supplierId)) {
                alert('رقم المورد غير صالح');
                window.location.href = '/Superadmin/suppliers/suppliers.html';
                return;
            }

            const supplier = suppliers.find(s => s.id === supplierId);
            if (!supplier) {
                alert('المورد غير موجود');
                window.location.href = '/Superadmin/suppliers/suppliers.html';
                return;
            }

            document.getElementById('supplierName').textContent = supplier.name || 'غير متوفر';
            document.getElementById('supplierContactPerson').textContent = supplier.contactPerson || 'غير متوفر';
            document.getElementById('supplierPhone').textContent = supplier.phone || 'غير متوفر';
            document.getElementById('supplierEmail').textContent = supplier.email || 'غير متوفر';
            document.getElementById('supplierAddress').textContent = supplier.address || 'غير متوفر';
            document.getElementById('supplierVendorName').textContent = supplier.vendorName || 'غير متوفر';
            document.getElementById('supplierWarehouseNames').textContent = supplier.warehouseNames.join(', ') || 'غير متوفر';

            document.getElementById('detailName').textContent = supplier.name || 'غير متوفر';
            document.getElementById('detailContactPerson').textContent = supplier.contactPerson || 'غير متوفر';
            document.getElementById('detailPhone').textContent = supplier.phone || 'غير متوفر';
            document.getElementById('detailEmail').textContent = supplier.email || 'غير متوفر';
            document.getElementById('detailAddress').textContent = supplier.address || 'غير متوفر';
            document.getElementById('detailVendorName').textContent = supplier.vendorName || 'غير متوفر';
            document.getElementById('detailWarehouseNames').textContent = supplier.warehouseNames.join(', ') || 'غير متوفر';

            document.getElementById('editName').value = supplier.name || '';
            document.getElementById('editContactPerson').value = supplier.contactPerson || '';
            document.getElementById('editPhone').value = supplier.phone || '';
            document.getElementById('editEmail').value = supplier.email || '';
            document.getElementById('editAddress').value = supplier.address || '';

            // Populate vendor dropdown
            const vendorSelect = document.getElementById('editVendorId');
            vendorSelect.innerHTML = '<option value="">اختر الشركة</option>';
            vendors.forEach(vendor => {
                const option = document.createElement('option');
                option.value = vendor.id;
                option.textContent = vendor.name;
                option.selected = vendor.id === supplier.vendorId;
                vendorSelect.appendChild(option);
            });

            // Populate warehouse dropdown
            const warehouseSelect = document.getElementById('editWarehouseIds');
            warehouseSelect.innerHTML = '';
            warehouses.forEach(warehouse => {
                const option = document.createElement('option');
                option.value = warehouse.id;
                option.textContent = warehouse.name;
                option.selected = supplier.warehouseIds.includes(warehouse.id);
                warehouseSelect.appendChild(option);
            });

            loadSupplierInvoices(supplier);
            loadSupplierReturns(supplier);
            loadSupplierStatement(supplier);

            // Set dynamic href for "إضافة دفعة" button
            document.getElementById('addSupplierPaymentBtn').href = `/Superadmin/suppliers/payment/add-payment.html?id=${supplierId}`;
        }

        // Load supplier invoices
        function loadSupplierInvoices(supplier) {
            const tableBody = document.getElementById('supplierInvoicesTable');
            tableBody.innerHTML = '';
            const supplierInvoices = invoices.filter(i => i.supplierId === supplier.id && i.type === 'purchase');
            supplierInvoices.forEach(invoice => {
                const row = document.createElement('tr');
                let statusClass = 'badge-warning';
                if (invoice.status === 'مدفوع') statusClass = 'badge-success';
                if (invoice.status === 'مدفوع جزئيًا') statusClass = 'badge-info';
                if (invoice.status === 'ملغى') statusClass = 'badge-danger';
                row.innerHTML = `
                    <td>${invoice.invoiceNumber || 'غير متوفر'}</td>
                    <td>${formatDate(invoice.date)}</td>
                    <td>${invoice.vendorName || 'غير متوفر'}</td>
                    <td>${invoice.warehouseName || 'غير متوفر'}</td>
                    <td>${invoice.total ? invoice.total.toLocaleString() + ' ج.م' : 'غير متوفر'}</td>
                    <td><span class="badge ${statusClass}">${invoice.status || 'غير متوفر'}</span></td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Load supplier returns
        function loadSupplierReturns(supplier) {
            const tableBody = document.getElementById('supplierReturnsTable');
            tableBody.innerHTML = '';
            const supplierReturns = returns.filter(r => r.supplierId === supplier.id);
            supplierReturns.forEach(returnItem => {
                const row = document.createElement('tr');
                let statusClass = returnItem.status === 'معتمد' ? 'badge-success' : 'badge-warning';
                row.innerHTML = `
                    <td>${returnItem.returnNumber || 'غير متوفر'}</td>
                    <td>${formatDate(returnItem.date)}</td>
                    <td>${returnItem.total ? returnItem.total.toLocaleString() + ' ج.م' : 'غير متوفر'}</td>
                    <td><span class="badge ${statusClass}">${returnItem.status || 'غير متوفر'}</span></td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Load supplier statement
        function loadSupplierStatement(supplier) {
            const tableBody = document.getElementById('supplierStatementTable');
            tableBody.innerHTML = '';
            const supplierInvoices = invoices.filter(i => i.supplierId === supplier.id && i.type === 'purchase' && i.status !== 'ملغى');
            const supplierReturns = returns.filter(r => r.supplierId === supplier.id && r.status === 'معتمد');
            const supplierPayments = payments.filter(p => p.supplierId === supplier.id);

            const statementItems = [
                ...supplierInvoices.map(i => ({
                    date: i.date,
                    type: 'فاتورة',
                    description: `فاتورة شراء رقم ${i.invoiceNumber}`,
                    amount: i.total || 0,
                    isDebit: true
                })),
                ...supplierReturns.map(r => ({
                    date: r.date,
                    type: 'مرتجع',
                    description: `مرتجع مشتريات رقم ${r.returnNumber}`,
                    amount: r.total || 0,
                    isDebit: false
                })),
                ...supplierPayments.map(p => ({
                    date: p.date,
                    type: 'دفعة',
                    description: `دفعة للمورد`,
                    amount: p.amount || 0,
                    isDebit: false
                }))
            ];

            statementItems.sort((a, b) => new Date(a.date) - new Date(b.date));

            let balance = 0;
            statementItems.forEach(item => {
                if (item.isDebit) {
                    balance += item.amount;
                } else {
                    balance -= item.amount;
                }
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(item.date)}</td>
                    <td>${item.type}</td>
                    <td>${item.description}</td>
                    <td>${item.amount.toLocaleString()} ج.م</td>
                    <td>${balance.toLocaleString()} ج.م</td>
                `;
                tableBody.appendChild(row);
            });

            if (statementItems.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5">لا توجد معاملات</td></tr>';
            }
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('ar-EG');
        }

        // Save supplier changes
        function saveSupplierChanges() {
            if (currentUser.role !== "Super Admin") {
                alert('غير مصرح لك بتعديل المورد');
                return;
            }
            const supplier = suppliers.find(s => s.id === supplierId);
            if (!supplier) {
                alert('المورد غير موجود');
                return;
            }

            const oldName = supplier.name;
            supplier.name = document.getElementById('editName').value;
            supplier.contactPerson = document.getElementById('editContactPerson').value;
            supplier.phone = document.getElementById('editPhone').value;
            supplier.email = document.getElementById('editEmail').value;
            supplier.address = document.getElementById('editAddress').value;
            supplier.vendorId = parseInt(document.getElementById('editVendorId').value) || supplier.vendorId;
            supplier.vendorName = vendors.find(v => v.id === supplier.vendorId)?.name || supplier.vendorName;
            supplier.warehouseIds = Array.from(document.getElementById('editWarehouseIds').selectedOptions).map(opt => parseInt(opt.value));
            supplier.warehouseNames = supplier.warehouseIds.map(id => warehouses.find(w => w.id === id)?.name || 'غير متوفر');

            // Update invoices, returns, and payments with new supplier name
            invoices = invoices.map(i => i.supplierId === supplier.id ? { ...i, supplierName: supplier.name } : i);
            returns = returns.map(r => r.supplierId === supplier.id ? { ...r, supplierName: supplier.name } : r);
            payments = payments.map(p => p.supplierId === supplier.id ? { ...p, supplierName: supplier.name } : p);

            localStorage.setItem('suppliers', JSON.stringify(suppliers));
            localStorage.setItem('invoices', JSON.stringify(invoices));
            localStorage.setItem('returns', JSON.stringify(returns));
            localStorage.setItem('payments', JSON.stringify(payments));

            // Log transaction
            const transaction = {
                id: transactions.length ? Math.max(...transactions.map(t => t.id)) + 1 : 1,
                date: new Date().toISOString(),
                user: currentUser.name || "سوبر أدمن",
                action: `تعديل بيانات المورد ${supplier.name}`
            };
            transactions.push(transaction);
            localStorage.setItem('transactions', JSON.stringify(transactions));

            alert('تم حفظ التغييرات بنجاح');
            loadSupplierDetails();
        }

        // Show delete supplier confirmation
        function showDeleteSupplierConfirm() {
            if (currentUser.role !== "Super Admin") {
                alert('غير مصرح لك بحذف المورد');
                return;
            }
            const supplier = suppliers.find(s => s.id === supplierId);
            if (!supplier) {
                alert('المورد غير موجود');
                return;
            }

            if (confirm('هل أنت متأكد من حذف هذا المورد؟ لا يمكن التراجع عن هذا الإجراء.')) {
                suppliers = suppliers.filter(s => s.id !== supplierId);
                invoices = invoices.map(i => i.supplierId === supplierId ? { ...i, supplierName: 'غير متوفر', supplierId: null } : i);
                returns = returns.map(r => r.supplierId === supplierId ? { ...r, supplierName: 'غير متوفر', supplierId: null } : r);
                payments = payments.map(p => p.supplierId === supplierId ? { ...p, supplierName: 'غير متوفر', supplierId: null } : p);

                localStorage.setItem('suppliers', JSON.stringify(suppliers));
                localStorage.setItem('invoices', JSON.stringify(invoices));
                localStorage.setItem('returns', JSON.stringify(returns));
                localStorage.setItem('payments', JSON.stringify(payments));

                // Log transaction
                const transaction = {
                    id: transactions.length ? Math.max(...transactions.map(t => t.id)) + 1 : 1,
                    date: new Date().toISOString(),
                    user: currentUser.name || "سوبر أدمن",
                    action: `حذف المورد ${supplier.name}`
                };
                transactions.push(transaction);
                localStorage.setItem('transactions', JSON.stringify(transactions));

                alert('تم حذف المورد بنجاح');
                window.location.href = '/Superadmin/suppliers/suppliers.html';
            }
        }

        // Print functions
        function printInvoices() {
            window.print();
        }

        function printReturns() {
            window.print();
        }

        function printStatement() {
            window.print();
        }

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                this.classList.add('active');
                document.getElementById(this.getAttribute('data-tab')).classList.add('active');
            });
        });

        // Sidebar toggle
        document.getElementById('menuToggle').addEventListener('click', function() {
            document.getElementById('sidebar').classList.add('active');
            document.getElementById('sidebarOverlay').classList.add('active');
            document.body.style.overflow = 'hidden';
        });

        document.getElementById('sidebarClose').addEventListener('click', closeSidebar);
        document.getElementById('sidebarOverlay').addEventListener('click', closeSidebar);

        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('active');
            document.getElementById('sidebarOverlay').classList.remove('active');
            document.body.style.overflow = '';
        }

        // Load user info
        function loadUserInfo() {
            document.getElementById('userNameDisplay').textContent = currentUser.name || "سوبر أدمن";
        }

        // Initial setup
        loadUserInfo();
        loadSupplierDetails();

        // Check URL hash for default tab
        const hash = window.location.hash.replace('#', '');
        if (hash) {
            const tab = document.querySelector(`.tab[data-tab="${hash}"]`);
            if (tab) {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(hash).classList.add('active');
            }
        }
    </script>
</body>
</html>